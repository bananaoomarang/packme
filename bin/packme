#!/usr/bin/env node

var Path        = require('path');
var Fs          = require('fs');
var Bluebird    = require('bluebird');
var MkdirpAsync = Bluebird.promisify(require('mkdirp'));

Bluebird.promisifyAll(Fs);

var argv = require('yargs')
  .usage('Usage: packme <package> <infrom> <outto>')
  .demand(3)
  .argv;

var package = argv._[0];
var infrom  = argv._[1];
var outto   = argv._[2];

var pkgdir  = Path.join(process.cwd(), package);

var _in = require(Path.join('../ins',  infrom))
var out = require(Path.join('../outs', outto));

var pkgCache = {};

function main(pkg, i, o) {
    var prefixedPkgname = [infrom, pkg].join('-');

    return i(pkg)
        .tap(function (transPKG) {
            //XXX This code ignores versions

            var depends  = Object.keys(transPKG.depends);
            var prefixed = depends.map(function (dep) { return [infrom, dep].join('-'); });

            transPKG.pkgname = prefixedPkgname;
            transPKG.depends = prefixed;

            return Bluebird.all(
                prefixed
                  .map(function (dep, index) {
                      if(pkgCache[dep])
                          return dep;

                      pkgCache[dep] = true;

                      return main(depends[index], i, o);
                  })
            );
        })
        .tap(function (transPKG) {
            return MkdirpAsync(prefixedPkgname);
        })
        .then(function (transPKG) {
            var result = o(transPKG);

            return Bluebird.all(Object.keys(result))
                .map(function (key) {
                    return Fs.writeFileAsync(prefixedPkgname + '/' + key, result[key]);
                });
        });
}

main(package, _in, out);

